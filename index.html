<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plinth — Vinyl Player</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@300;400;500&display=swap" rel="stylesheet">
<style>
/* ─── RESET & BASE ──────────────────────────────────────────── */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

:root {
  --bg:         #0f0f10;
  --ink:        #f2f2f2;
  --muted:      #8b8b8b;
  --accent:     #c8503a;
  --panel-bg:   #151516;
  --panel-border: rgba(255,255,255,0.06);
  --transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

html, body {
  height: 100%;
  background: var(--bg);
  color: var(--ink);
  font-family: 'DM Mono', monospace;
  overflow: hidden;
}

/* ─── AUTH SCREEN ───────────────────────────────────────────── */
#auth-screen {
  position: fixed; inset: 0;
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  background: var(--bg);
  z-index: 100;
  gap: 2rem;
}
#auth-screen h1 {
  font-family: 'DM Serif Display', serif;
  font-size: clamp(3rem, 6vw, 5rem);
  letter-spacing: -0.02em;
}
#auth-screen p {
  color: var(--muted);
  font-size: 0.78rem;
  letter-spacing: 0.1em;
  text-transform: uppercase;
}
#login-btn {
  background: var(--ink);
  color: var(--bg);
  border: none;
  padding: 1rem 2.5rem;
  font-family: 'DM Mono', monospace;
  font-size: 0.75rem;
  letter-spacing: 0.15em;
  text-transform: uppercase;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  transition: var(--transition);
}
#login-btn::after {
  content: '';
  position: absolute; inset: 0;
  background: var(--accent);
  transform: translateX(-100%);
  transition: var(--transition);
}
#login-btn:hover::after { transform: translateX(0); }
#login-btn span { position: relative; z-index: 1; }

.auth-vinyl {
  width: 160px; height: 160px;
  border-radius: 50%;
  background: radial-gradient(circle, #3a3a38 0%, #1a1a18 40%, #2a2a28 41%, #1a1a18 60%, #2a2a28 61%, #1a1a18 100%);
  box-shadow: 0 20px 60px rgba(0,0,0,0.3);
  animation: spin-slow 8s linear infinite;
  position: relative;
}
.auth-vinyl::after {
  content: '';
  position: absolute;
  top: 50%; left: 50%;
  width: 44px; height: 44px;
  background: #888;
  border-radius: 50%;
  transform: translate(-50%, -50%);
  box-shadow: inset 0 0 8px rgba(0,0,0,0.5);
}
@keyframes spin-slow { to { transform: rotate(360deg); } }

/* ─── MAIN APP LAYOUT ───────────────────────────────────────── */
#app {
  display: none;
  height: 100vh;
  width: 100vw;
}
#app.visible {
  display: grid;
  grid-template-columns: 1fr 340px;
  grid-template-rows: 52px 1fr;
  /* critical: children do not overflow */
  overflow: hidden;
}

/* ─── HEADER ────────────────────────────────────────────────── */
#header {
  grid-column: 1 / -1;
  padding: 0 1.6rem;
  display: flex;
  align-items: center;
  justify-content: space-between;
  border-bottom: 1px solid rgba(0,0,0,0.1);
  background: rgba(15,15,16,0.85);
  backdrop-filter: blur(10px);
  z-index: 20;
}
#header h1 {
  font-family: 'DM Serif Display', serif;
  font-size: 1.35rem;
  letter-spacing: -0.02em;
}
#user-info {
  font-size: 0.67rem;
  color: var(--muted);
  letter-spacing: 0.05em;
  display: flex;
  align-items: center;
  gap: 0.6rem;
}
#status-dot {
  width: 7px; height: 7px;
  border-radius: 50%;
  background: #bbb;
  transition: background 0.5s;
  flex-shrink: 0;
}
#status-dot.ready {
  background: #5cb85c;
  box-shadow: 0 0 6px rgba(92,184,92,0.6);
}

/* ─── SCENE CONTAINER ───────────────────────────────────────── */
#scene-container {
  /* fill grid cell completely — no overflow, no cropping */
  position: relative;
  overflow: hidden;
  cursor: pointer;
  min-height: 0;   /* prevents implicit min-height from grid */
  min-width: 0;
}
/* Subtle vignette — darkens edges, focuses eye on vinyl */
#scene-container::after {
  content: '';
  position: absolute;
  inset: 0;
  pointer-events: none;
  background: radial-gradient(circle at center, rgba(0,0,0,0) 55%, rgba(0,0,0,0.18) 100%);
  mix-blend-mode: multiply;
  z-index: 4;
}

/* canvas-wrap uses absolute fill so it doesn't affect layout */
#canvas-wrap {
  position: absolute;
  inset: 0;
}
/* Three.js writes inline width/height; override to match container */
#canvas-wrap canvas {
  display: block;
  width: 100% !important;
  height: 100% !important;
}

/* ─── NOW PLAYING ───────────────────────────────────────────── */
#now-playing {
  position: absolute;
  bottom: 1.8rem;
  left: 2rem;
  max-width: 320px;
  pointer-events: none;
  z-index: 5;
}
#now-playing .track-name {
  font-family: 'DM Serif Display', serif;
  font-size: 1.45rem;
  line-height: 1.15;
  color: var(--ink);
  margin-bottom: 0.22rem;
  text-shadow: 0 2px 16px rgba(232,226,217,0.9);
}
#now-playing .artist-name {
  font-size: 0.67rem;
  color: var(--muted);
  letter-spacing: 0.1em;
  text-transform: uppercase;
}

/* ─── VINYL COLOR CONTROLS ──────────────────────────────────── */
#vinyl-controls {
  position: absolute;
  bottom: 2rem;
  /* sits left of the play button; play button is 52px wide + 1.8rem margin */
  right: 5rem;
  display: flex;
  align-items: center;
  gap: 0.48rem;
  z-index: 5;
  pointer-events: all;
  background: rgba(232,226,217,0.85);
  backdrop-filter: blur(10px);
  border: 1px solid rgba(0,0,0,0.1);
  border-radius: 28px;
  padding: 0.38rem 0.7rem;
}
.vc-label {
  font-size: 0.53rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  margin-right: 0.1rem;
  user-select: none;
}
.vc-swatch {
  width: 20px; height: 20px;
  border-radius: 50%;
  border: 2px solid transparent;
  cursor: pointer;
  transition: border-color 0.18s, transform 0.18s;
  flex-shrink: 0;
  outline: none;
}
.vc-swatch:hover { transform: scale(1.18); }
.vc-swatch.active { border-color: var(--ink); }
#vc-black { background: #181816; }
#vc-album {
  background: conic-gradient(#e63946 0deg, #f4a261 90deg, #2a9d8f 180deg, #264653 270deg, #e63946 360deg);
}
/* Custom color picker styled as a swatch circle */
#vc-picker-wrap {
  width: 20px; height: 20px;
  border-radius: 50%;
  overflow: hidden;
  flex-shrink: 0;
  border: 2px solid rgba(0,0,0,0.18);
  transition: border-color 0.18s, transform 0.18s;
  cursor: pointer;
}
#vc-picker-wrap:hover { transform: scale(1.18); }
#vc-picker-wrap.active { border-color: var(--ink); }
#vc-picker {
  width: 150%;
  height: 150%;
  margin: -25% 0 0 -25%;
  border: none;
  padding: 0;
  cursor: pointer;
  background: none;
}

/* ─── PLAY BUTTON ───────────────────────────────────────────── */
#play-btn {
  position: absolute;
  bottom: 1.8rem;
  right: 1.8rem;
  width: 52px; height: 52px;
  border-radius: 50%;
  background: var(--ink);
  border: none;
  cursor: pointer;
  display: flex; align-items: center; justify-content: center;
  transition: transform 0.22s cubic-bezier(0.4,0,0.2,1), background 0.22s;
  box-shadow: 0 6px 28px rgba(0,0,0,0.28), 0 2px 8px rgba(0,0,0,0.14);
  pointer-events: all;
  z-index: 5;
}
#play-btn:hover { transform: scale(1.1); background: var(--accent); }
#play-btn:active { transform: scale(0.95); }
#play-btn svg { fill: white; }

/* ─── LIBRARY PANEL ─────────────────────────────────────────── */
#album-panel {
  background: var(--panel-bg);
  border-left: 1px solid var(--panel-border);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  min-height: 0;
  min-width: 0;
}

/* Tabs */
#panel-tabs {
  display: flex;
  border-bottom: 1px solid var(--panel-border);
  flex-shrink: 0;
}
.panel-tab {
  flex: 1;
  padding: 0.72rem 0.4rem;
  font-size: 0.59rem;
  letter-spacing: 0.13em;
  text-transform: uppercase;
  color: var(--muted);
  cursor: pointer;
  text-align: center;
  border: none;
  border-bottom: 2px solid transparent;
  background: none;
  font-family: 'DM Mono', monospace;
  transition: color 0.2s, border-color 0.2s;
}
.panel-tab:hover { color: var(--ink); }
.panel-tab.active { color: var(--ink); border-bottom-color: var(--accent); }

/* Scrollable list */
#library-list {
  flex: 1;
  overflow-y: auto;
  overflow-x: hidden;
  padding: 0.55rem;
  display: flex;
  flex-direction: column;
  gap: 0.4rem;
  min-height: 0;
}
#library-list::-webkit-scrollbar { width: 2px; }
#library-list::-webkit-scrollbar-track { background: transparent; }
#library-list::-webkit-scrollbar-thumb { background: rgba(0,0,0,0.18); border-radius: 2px; }

/* ─── LIBRARY CARD (vinyl-stacked style) ────────────────────── */
.lib-card {
  display: flex;
  align-items: center;
  gap: 0.7rem;
  padding: 0.45rem 0.55rem;
  border-radius: 5px;
  cursor: pointer;
  transition: background 0.2s, transform 0.25s;
  position: relative;
  /* subtle perspective tilt on hover */
  transform-origin: left center;
  flex-shrink: 0;
}
.lib-card:hover {
  background: rgba(0,0,0,0.05);
  transform: perspective(500px) rotateY(-2.5deg) translateX(2px);
}
.lib-card.active {
  background: rgba(200,80,58,0.09);
}
.lib-card.active .lib-name { color: var(--accent); }

/* Active left bar */
.lib-card.active::before {
  content: '';
  position: absolute;
  left: 0; top: 18%; bottom: 18%;
  width: 3px;
  background: var(--accent);
  border-radius: 0 2px 2px 0;
}

/* Circular vinyl-disc thumbnail wrapper */
.lib-art-wrap {
  width: 52px;
  height: 52px;
  border-radius: 50%;
  background: radial-gradient(circle, #222 60%, #000 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}
.lib-art {
  width: 46px;
  height: 46px;
  border-radius: 50%;
  object-fit: cover;
  position: relative;
  z-index: 1;
  box-shadow: 0 3px 12px rgba(0,0,0,0.35);
  transition: box-shadow 0.2s, transform 0.25s;
}
.lib-card:hover .lib-art {
  box-shadow: 0 4px 18px rgba(0,0,0,0.45);
  transform: scale(1.06) rotate(-2deg);
}

.lib-meta { flex: 1; min-width: 0; }
.lib-name {
  font-size: 0.65rem;
  color: var(--ink);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  line-height: 1.4;
  transition: color 0.2s;
}
.lib-sub {
  font-size: 0.57rem;
  color: var(--muted);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin-top: 0.08rem;
}
.lib-type {
  font-size: 0.47rem;
  letter-spacing: 0.12em;
  text-transform: uppercase;
  color: var(--muted);
  border: 1px solid rgba(0,0,0,0.14);
  padding: 0.08rem 0.28rem;
  border-radius: 2px;
  flex-shrink: 0;
  align-self: flex-start;
  margin-top: 0.18rem;
}

/* Skeleton */
.lib-skeleton {
  height: 60px;
  border-radius: 5px;
  background: linear-gradient(90deg, #cac4bb 25%, #b8b2a8 50%, #cac4bb 75%);
  background-size: 200% 100%;
  animation: shimmer 1.4s infinite;
  flex-shrink: 0;
}
@keyframes shimmer { to { background-position: -200% 0; } }

/* ─── TOAST ─────────────────────────────────────────────────── */
#toast {
  position: fixed;
  bottom: 2rem;
  left: 50%;
  transform: translateX(-50%) translateY(80px);
  background: var(--ink);
  color: var(--bg);
  padding: 0.55rem 1.3rem;
  font-size: 0.67rem;
  letter-spacing: 0.08em;
  border-radius: 3px;
  transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1);
  z-index: 300;
  pointer-events: none;
}
#toast.show { transform: translateX(-50%) translateY(0); }
</style>
</head>
<body>

<!-- ═══════════════════════════ AUTH ════════════════════════════ -->
<div id="auth-screen">
  <div class="auth-vinyl"></div>
  <h1>Plinth</h1>
  <p>A vinyl record player for Spotify</p>
  <button id="login-btn"><span>Connect with Spotify</span></button>
</div>

<!-- ════════════════════════════ APP ════════════════════════════ -->
<div id="app">
  <header id="header">
    <h1>Plinth</h1>
    <div id="user-info">
      <span id="status-dot"></span>
      <span id="user-name">Connecting…</span>
    </div>
  </header>

  <!-- 3-D Turntable scene -->
  <div id="scene-container">
    <div id="canvas-wrap"></div>

    <!-- Now playing (bottom-left) -->
    <div id="now-playing">
      <div class="track-name" id="track-name">Select an album</div>
      <div class="artist-name" id="artist-name">— —</div>
    </div>

    <!-- Vinyl color selector -->
    <div id="vinyl-controls">
      <span class="vc-label">Vinyl</span>
      <div class="vc-swatch active" id="vc-black"  title="Classic black"></div>
      <div class="vc-swatch"        id="vc-album"  title="Album color"></div>
      <div class="vc-picker-wrap"   id="vc-picker-wrap" title="Custom color">
        <input type="color" id="vc-picker" value="#2b1f4e">
      </div>
    </div>

    <!-- Play / Pause -->
    <button id="play-btn" title="Play / Pause">
      <svg id="play-icon"  width="20" height="20" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></svg>
      <svg id="pause-icon" width="20" height="20" viewBox="0 0 24 24" style="display:none"><path d="M6 19h4V5H6v14zm8-14v14h4V5h-4z"/></svg>
    </button>
  </div>

  <!-- Library panel -->
  <div id="album-panel">
    <div id="panel-tabs">
      <button class="panel-tab active" data-tab="albums">Albums</button>
      <button class="panel-tab"        data-tab="playlists">Playlists</button>
    </div>
    <div id="library-list"></div>
  </div>
</div>

<div id="toast"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://sdk.scdn.co/spotify-player.js"></script>

<script>
// ══════════════════════════════════════════════════════════════
// ██████  AUTH — PKCE  [UNTOUCHED]
// ══════════════════════════════════════════════════════════════

const SPOTIFY_CLIENT_ID = 'da4b6036031f4a8894a748518b802e6e';
const REDIRECT_URI      = 'https://akhosla2004.github.io/plinth/';
const SCOPES = [
  'streaming',
  'user-library-read',
  'user-read-email',
  'user-read-private',
  'user-read-playback-state',
  'user-modify-playback-state',
  'playlist-read-private',
  'playlist-read-collaborative'
].join(' ');

function generateCodeVerifier(length = 128) {
  const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789-._~';
  return Array.from(crypto.getRandomValues(new Uint8Array(length)))
    .map(b => chars[b % chars.length]).join('');
}

async function generateCodeChallenge(verifier) {
  const data = new TextEncoder().encode(verifier);
  const hash = await crypto.subtle.digest('SHA-256', data);
  return btoa(String.fromCharCode(...new Uint8Array(hash)))
    .replace(/\+/g,'-').replace(/\//g,'_').replace(/=+$/,'');
}

async function startLogin() {
  const verifier = generateCodeVerifier();
  const challenge = await generateCodeChallenge(verifier);
  sessionStorage.setItem('pkce_verifier', verifier);
  const params = new URLSearchParams({
    client_id: SPOTIFY_CLIENT_ID, response_type: 'code',
    redirect_uri: REDIRECT_URI, code_challenge_method: 'S256',
    code_challenge: challenge, scope: SCOPES, show_dialog: 'false'
  });
  window.location.href = `https://accounts.spotify.com/authorize?${params}`;
}

// ══════════════════════════════════════════════════════════════
// ██████  TOKEN MANAGEMENT  [UNTOUCHED]
// ══════════════════════════════════════════════════════════════

async function exchangeCodeForToken(code) {
  const verifier = sessionStorage.getItem('pkce_verifier');
  if (!verifier) throw new Error('No PKCE verifier');
  const res = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_id: SPOTIFY_CLIENT_ID, grant_type: 'authorization_code',
      code, redirect_uri: REDIRECT_URI, code_verifier: verifier
    })
  });
  if (!res.ok) throw new Error('Token exchange failed: ' + await res.text());
  const data = await res.json();
  storeTokens(data);
  window.history.replaceState({}, '', REDIRECT_URI);
  return data.access_token;
}

function storeTokens(data) {
  sessionStorage.setItem('access_token',  data.access_token);
  sessionStorage.setItem('refresh_token', data.refresh_token);
  sessionStorage.setItem('token_expiry',  Date.now() + data.expires_in * 1000);
}

async function refreshAccessToken() {
  const refreshToken = sessionStorage.getItem('refresh_token');
  if (!refreshToken) throw new Error('No refresh token');
  const res = await fetch('https://accounts.spotify.com/api/token', {
    method: 'POST',
    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
    body: new URLSearchParams({
      client_id: SPOTIFY_CLIENT_ID, grant_type: 'refresh_token',
      refresh_token: refreshToken
    })
  });
  if (!res.ok) throw new Error('Token refresh failed');
  const data = await res.json();
  storeTokens(data);
  return data.access_token;
}

async function getAccessToken() {
  const expiry = parseInt(sessionStorage.getItem('token_expiry') || '0');
  if (Date.now() > expiry - 60_000) return await refreshAccessToken();
  return sessionStorage.getItem('access_token');
}

async function spotifyFetch(path, options = {}) {
  const token = await getAccessToken();
  const res = await fetch(`https://api.spotify.com/v1${path}`, {
    ...options,
    headers: { Authorization: `Bearer ${token}`, 'Content-Type': 'application/json', ...options.headers }
  });
  if (!res.ok) throw new Error(`Spotify API ${res.status} on ${path}`);
  if (res.status === 204) return null;
  return res.json();
}

// ══════════════════════════════════════════════════════════════
// ██████  SPOTIFY SDK  [UNTOUCHED]
// ══════════════════════════════════════════════════════════════

let player    = null;
let deviceId  = null;
let isPlaying = false;
let currentUri = null;
let currentProgress = 0;
let currentDuration = 1;

window.onSpotifyWebPlaybackSDKReady = () => {
  window._sdkReady = true;
  if (window._tokenReady) initPlayer();
};

function initPlayer() {
  player = new Spotify.Player({
    name: 'Plinth Vinyl Player',
    getOAuthToken: async cb => cb(await getAccessToken()),
    volume: 0.8
  });

  player.addListener('ready', ({ device_id }) => {
    deviceId = device_id;
    console.log('Plinth ready — device_id:', device_id);
    document.getElementById('status-dot').classList.add('ready');
    transferPlayback(device_id);
  });

  player.addListener('not_ready', ({ device_id }) => {
    console.warn('Device offline:', device_id);
    document.getElementById('status-dot').classList.remove('ready');
  });

  player.addListener('player_state_changed', onPlayerStateChanged);
  player.addListener('initialization_error', ({ message }) => showToast('Init error: ' + message));
  player.addListener('authentication_error', ({ message }) => showToast('Auth error: ' + message));
  player.addListener('account_error',        ()            => showToast('Requires Spotify Premium'));

  player.connect().then(ok => { if (!ok) showToast('Player connection failed'); });

  // Real-time progress polling for tonearm sweep — visual only, no playback effect
  setInterval(async () => {
    if (!player) return;
    const state = await player.getCurrentState();
    if (!state) return;
    currentProgress = state.position;
    currentDuration = state.duration;
  }, 800);
}

async function transferPlayback(device_id) {
  try {
    await spotifyFetch('/me/player', {
      method: 'PUT',
      body: JSON.stringify({ device_ids: [device_id], play: false })
    });
  } catch (e) { console.warn('transferPlayback:', e); }
}

// Called on every play/pause/skip event — drives all visual updates
function onPlayerStateChanged(state) {
  if (!state) return;

  isPlaying = !state.paused;
  currentProgress = state.position;
  currentDuration = state.duration;

  // Update play button icon
  updatePlayButton();

  // Drive tonearm visually on every state change — purely visual, no playback calls
  updateTonearm();

  // Update now-playing text
  const track = state.track_window?.current_track;
  if (track) {
    document.getElementById('track-name').textContent  = track.name;
    document.getElementById('artist-name').textContent = track.artists.map(a => a.name).join(', ');

    // Auto-update vinyl label on every track change / skip
    const albumImg = track.album?.images?.[0]?.url;
    if (albumImg) {
      loadAlbumArtTexture(albumImg);
      if (activeVinylMode === 'album') extractAndApplyDominantColor(albumImg);
    }

    // Highlight active library item
    const albumUri = track.album?.uri;
    if (albumUri) highlightLibraryItem(albumUri);
  }
}

async function togglePlayback() {
  if (!player) return;
  await player.togglePlay();
}

async function playContext(contextUri, coverUrl) {
  if (!deviceId) { showToast('Player not ready yet'); return; }
  try {
    await spotifyFetch('/me/player/play', {
      method: 'PUT',
      body: JSON.stringify({ context_uri: contextUri, device_id: deviceId })
    });
    currentUri = contextUri;
    if (coverUrl) loadAlbumArtTexture(coverUrl);
  } catch (e) {
    showToast('Playback error — requires Spotify Premium');
    console.error(e);
  }
}

// ══════════════════════════════════════════════════════════════
// ██████  DATA FETCH — Albums + Playlists
// ══════════════════════════════════════════════════════════════

let allAlbums    = [];
let allPlaylists = [];
let activeTab    = 'albums';

async function loadLibrary() {
  const list = document.getElementById('library-list');
  list.innerHTML = '';
  for (let i = 0; i < 8; i++) {
    const sk = document.createElement('div');
    sk.className = 'lib-skeleton';
    list.appendChild(sk);
  }

  // Fetch albums and playlists independently so one failure doesn't block the other
  const albumResult    = await spotifyFetch('/me/albums?limit=20').catch(e => { console.error('Albums fetch failed:', e); return null; });
  const playlistResult = await spotifyFetch('/me/playlists?limit=20').catch(e => { console.error('Playlists fetch failed:', e); return null; });

  allAlbums    = albumResult?.items    || [];
  allPlaylists = playlistResult?.items || [];

  renderLibrary();
}

function renderLibrary() {
  const list = document.getElementById('library-list');
  list.innerHTML = '';

  const items = activeTab === 'albums'
    ? allAlbums.map(i => ({
        uri:   i.album.uri,
        name:  i.album.name,
        sub:   i.album.artists.map(a => a.name).join(', '),
        img:   i.album.images[1]?.url || i.album.images[0]?.url || '',
        cover: i.album.images[0]?.url || '',
        type:  'album'
      }))
    : allPlaylists.map(i => ({
        uri:   i.uri,
        name:  i.name,
        sub:   `${i.tracks?.total ?? '?'} tracks`,
        img:   i.images?.[0]?.url || 'https://via.placeholder.com/300/ccc/666?text=Playlist',
        cover: i.images?.[0]?.url || '',
        type:  'playlist'
      }));

  if (!items.length) {
    const msg = activeTab === 'albums'
      ? 'No saved albums found'
      : 'No playlists found — try saving one on Spotify';
    list.innerHTML = `<p style="padding:1.2rem 1rem;font-size:0.68rem;color:var(--muted);line-height:1.5">${msg}</p>`;
    return;
  }

  items.forEach(item => {
    const card = document.createElement('div');
    card.className = 'lib-card';
    card.dataset.uri = item.uri;
    card.innerHTML = `
      <div class="lib-art-wrap">
        <img class="lib-art" src="${item.img}" alt="${item.name}" loading="lazy">
      </div>
      <div class="lib-meta">
        <div class="lib-name">${item.name}</div>
        <div class="lib-sub">${item.sub}</div>
      </div>
      <span class="lib-type">${item.type}</span>
    `;
    card.addEventListener('click', () => {
      document.querySelectorAll('.lib-card').forEach(c => c.classList.remove('active'));
      card.classList.add('active');
      currentUri = item.uri;
      playContext(item.uri, item.cover);
    });
    if (currentUri === item.uri) card.classList.add('active');
    list.appendChild(card);
  });
}

function highlightLibraryItem(uri) {
  // Try to match album URI in current rendered list
  document.querySelectorAll('.lib-card').forEach(c => {
    c.classList.toggle('active', c.dataset.uri === uri);
  });
}

// Tab switching
document.querySelectorAll('.panel-tab').forEach(btn => {
  btn.addEventListener('click', () => {
    document.querySelectorAll('.panel-tab').forEach(t => t.classList.remove('active'));
    btn.classList.add('active');
    activeTab = btn.dataset.tab;
    renderLibrary();
  });
});

// ══════════════════════════════════════════════════════════════
// ██████  THREE.JS SCENE — Realistic Turntable
// ══════════════════════════════════════════════════════════════

let scene, camera, renderer;
let turntableGroup;          // root: plinth + everything
let vinylGroup;              // disc + label: rotates for spin
let vinylMesh;               // raw disc geometry
let vinylMaterial;           // disc MeshStandardMaterial — mutated by color controls
let labelMesh;               // center label
let tonearmGroup;            // full tonearm assembly
let albumTexture = null;

// Spin
let spinSpeed      = 0;
const TARGET_SPEED = 0.006; // ~33⅓ RPM

// Tonearm angles — arm geometry extends in -X, pivot is rear-right
// Positive Y rotation sweeps the arm inward (over record); negative swings it outward
const ARM_ON_RECORD   =  0.15; // arm rests inward on groove area when playing
const ARM_LIFTED      = -0.55; // arm swings outward/right when paused
let   tonearmTargetAngle  = ARM_LIFTED;
let   tonearmCurrentAngle = ARM_LIFTED;

// Tonearm height above plinth surface
const ARM_HEIGHT_ON     = 0.36; // touching record
const ARM_HEIGHT_LIFTED = 0.56; // raised up
let   tonearmTargetH  = ARM_HEIGHT_LIFTED;
let   tonearmCurrentH = ARM_HEIGHT_LIFTED;

// Vinyl color
let activeVinylMode = 'black';
let dominantColor   = '#181816';

// Called whenever isPlaying changes — updates tonearm targets (no playback side effects)
function updateTonearm() {
  if (isPlaying) {
    // Music playing → arm DOWN on record
    tonearmTargetAngle = ARM_ON_RECORD;
    tonearmTargetH     = ARM_HEIGHT_ON;
  } else {
    // Music paused/stopped → arm LIFTED
    tonearmTargetAngle = ARM_LIFTED;
    tonearmTargetH     = ARM_HEIGHT_LIFTED;
  }
}

function initThree() {
  const container = document.getElementById('canvas-wrap');

  // Measure real pixel size AFTER layout
  const W = container.offsetWidth  || 800;
  const H = container.offsetHeight || 600;

  // ── Renderer ──────────────────────────────────────────────
  renderer = new THREE.WebGLRenderer({ antialias: true });
  renderer.setSize(W, H);
  renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
  renderer.physicallyCorrectLights = true;
  renderer.outputEncoding = THREE.sRGBEncoding;
  renderer.toneMapping = THREE.ACESFilmicToneMapping;
  renderer.toneMappingExposure = 1.15;
  renderer.shadowMap.enabled = true;
  renderer.shadowMap.type = THREE.PCFSoftShadowMap;
  container.appendChild(renderer.domElement);

  // ── Scene ─────────────────────────────────────────────────
  scene = new THREE.Scene();
  const bgCanvas = document.createElement('canvas');
  bgCanvas.width = 2;
  bgCanvas.height = 512;
  const bgCtx = bgCanvas.getContext('2d');
  const g = bgCtx.createLinearGradient(0, 0, 0, 512);
  g.addColorStop(0, '#141416');
  g.addColorStop(1, '#09090a');
  bgCtx.fillStyle = g;
  bgCtx.fillRect(0, 0, 2, 512);
  scene.background = new THREE.CanvasTexture(bgCanvas);
  scene.fog = new THREE.Fog(0x0d0d0e, 18, 32);

  // Soft back glow plane — creates depth separation behind album cover
  const halo = new THREE.Mesh(
    new THREE.PlaneGeometry(10, 10),
    new THREE.MeshBasicMaterial({ color: 0x1f1f25, transparent: true, opacity: 0.35 })
  );
  halo.position.set(0, 0, -8);
  scene.add(halo);

  // ── Dark studio HDR-style environment ─────────────────────
  const envCanvas = document.createElement('canvas');
  envCanvas.width = 1024;
  envCanvas.height = 512;
  const envCtx = envCanvas.getContext('2d');

  const grad = envCtx.createLinearGradient(0, 0, 0, 512);
  grad.addColorStop(0,   '#1a1a1c');
  grad.addColorStop(0.4, '#111113');
  grad.addColorStop(1,   '#050506');
  envCtx.fillStyle = grad;
  envCtx.fillRect(0, 0, 1024, 512);

  // Bright highlight band simulates studio strip light — creates specular streak on vinyl
  envCtx.fillStyle = 'rgba(255,255,255,0.25)';
  envCtx.fillRect(0, 200, 1024, 40);

  const envTexture = new THREE.CanvasTexture(envCanvas);
  envTexture.mapping = THREE.EquirectangularReflectionMapping;

  const pmrem = new THREE.PMREMGenerator(renderer);
  scene.environment = pmrem.fromEquirectangular(envTexture).texture;

  // ── Camera ────────────────────────────────────────────────
  camera = new THREE.PerspectiveCamera(35, W / H, 0.1, 100);
  camera.position.set(0, 2.1, 7.8);
  camera.lookAt(0, 0, 0);

  // ── Lighting ──────────────────────────────────────────────
  const ambient = new THREE.AmbientLight(0xffffff, 0.18);
  scene.add(ambient);

  // Strong cinematic key light
  const keyLight = new THREE.DirectionalLight(0xffffff, 22);
  keyLight.position.set(-6, 9, 6);
  keyLight.castShadow = true;
  keyLight.shadow.mapSize.set(2048, 2048);
  keyLight.shadow.radius = 6;
  keyLight.shadow.bias = -0.0005;
  scene.add(keyLight);

  // Blue edge rim light — subtle asymmetric metal highlight
  const rimLight = new THREE.DirectionalLight(0x4a7dff, 2.4);
  rimLight.position.set(8, 3, -6);
  scene.add(rimLight);

  // ── Build geometry ─────────────────────────────────────────
  turntableGroup = new THREE.Group();
  scene.add(turntableGroup);

  buildAlbumCover();
  buildVinylRecord();
  buildTonearm();

  // Reposition vinyl to overlap album cover slightly
  vinylGroup.position.set(1.5, 0, 0);

  // Initialize tonearm — no plinth so anchor directly in world space
  tonearmGroup.rotation.y = -0.8;

  // Ground shadow plane — anchors scene and receives cast shadows
  const ground = new THREE.Mesh(
    new THREE.PlaneGeometry(40, 40),
    new THREE.ShadowMaterial({ opacity: 0.35 })
  );
  ground.rotation.x = -Math.PI / 2;
  ground.position.y = -0.08;
  ground.receiveShadow = true;
  scene.add(ground);

  // ── Responsive resize via ResizeObserver ───────────────────
  // This correctly handles the grid layout repaints
  const ro = new ResizeObserver(() => {
    const W2 = container.offsetWidth;
    const H2 = container.offsetHeight;
    if (W2 > 0 && H2 > 0) {
      camera.aspect = W2 / H2;
      camera.updateProjectionMatrix();
      renderer.setSize(W2, H2);
    }
  });
  ro.observe(container);

  animate();
}

// ── Upright album cover (physical box — has visible thickness) ─
function buildAlbumCover() {
  const geo = new THREE.BoxGeometry(4.8, 4.8, 0.18);
  const materials = [
    new THREE.MeshStandardMaterial({ color: 0xf5f5f5, roughness: 0.5 }), // right
    new THREE.MeshStandardMaterial({ color: 0xf5f5f5, roughness: 0.5 }), // left
    new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.5 }), // top
    new THREE.MeshStandardMaterial({ color: 0xeeeeee, roughness: 0.5 }), // bottom
    new THREE.MeshStandardMaterial({ color: 0xffffff, roughness: 0.5 }), // front
    new THREE.MeshStandardMaterial({ color: 0xf2f2f2, roughness: 0.5 })  // back
  ];
  const cover = new THREE.Mesh(geo, materials);
  cover.position.set(-3.2, 0, -0.09);
  cover.rotation.y = 0.18;
  cover.castShadow = true;
  cover.receiveShadow = true;
  scene.add(cover);
  window.albumCoverMesh = cover;
}

// ── Vinyl record ──────────────────────────────────────────────
function buildVinylRecord() {
  vinylGroup = new THREE.Group();
  // Position set after build in initThree() via vinylGroup.position.set(1.5, 0, 0)
  turntableGroup.add(vinylGroup);

  // ── Groove texture ─────────────────────────────────────────
  const gSize = 1024;
  const gCanvas = document.createElement('canvas');
  gCanvas.width = gCanvas.height = gSize;
  const gc = gCanvas.getContext('2d');
  gc.fillStyle = '#0d0d0c';
  gc.fillRect(0, 0, gSize, gSize);

  const cx = gSize/2, cy = gSize/2;
  // Label occupies inner 35% of disc radius; grooves start at 36%
  const innerR = gSize * 0.37;
  const outerR = gSize * 0.487;
  const step   = 3.0;

  for (let r = innerR; r < outerR; r += step) {
    const b = 12 + Math.sin(r*0.24)*6 + Math.sin(r*0.08)*3;
    gc.strokeStyle = `rgb(${b|0},${b|0},${(b-1)|0})`;
    gc.lineWidth = step * 0.6;
    gc.beginPath(); gc.arc(cx, cy, r, 0, Math.PI*2); gc.stroke();
  }
  // Lead-in groove (slightly brighter band)
  gc.strokeStyle = '#1c1c1a'; gc.lineWidth = 4;
  gc.beginPath(); gc.arc(cx, cy, innerR+4, 0, Math.PI*2); gc.stroke();

  const grooveMap = new THREE.CanvasTexture(gCanvas);
  grooveMap.encoding = THREE.sRGBEncoding;

  // Roughness map for iridescent groove sheen
  const rCanvas = document.createElement('canvas');
  rCanvas.width = rCanvas.height = 512;
  const rc = rCanvas.getContext('2d');
  rc.fillStyle = '#5a5a5a'; rc.fillRect(0, 0, 512, 512);
  for (let r = 512*0.37; r < 512*0.49; r += 1.6) {
    const v = 80 + Math.sin(r*0.42)*38 | 0;
    rc.strokeStyle = `rgb(${v},${v},${v})`; rc.lineWidth = 1.3;
    rc.beginPath(); rc.arc(256, 256, r, 0, Math.PI*2); rc.stroke();
  }
  const roughMap = new THREE.CanvasTexture(rCanvas);

  const discMat = new THREE.MeshPhysicalMaterial({
    map: grooveMap,
    roughnessMap: roughMap,
    color: 0x141414,
    roughness: 0.02,
    metalness: 0.85,
    clearcoat: 1.0,
    clearcoatRoughness: 0.005,
    envMapIntensity: 4.2
  });
  vinylMesh = new THREE.Mesh(new THREE.CylinderGeometry(2.9, 2.9, 0.06, 128), discMat);
  vinylMesh.castShadow = vinylMesh.receiveShadow = true;
  vinylGroup.add(vinylMesh);
  // Store material reference so color controls can mutate it directly without recreating the mesh
  vinylMaterial = discMat;

  // ── Center label — 45% of vinyl radius (2.72 * 0.45 ≈ 1.22) ──
  // Larger label for clearly visible album art; top-cap UV maps texture without distortion
  const labelGeo = new THREE.CylinderGeometry(1.36, 1.36, 0.066, 64);
  const labelMat = new THREE.MeshStandardMaterial({ color: 0xcccccc, roughness: 0.65 });
  labelMesh = new THREE.Mesh(labelGeo, labelMat);
  labelMesh.position.y = 0.003;
  vinylGroup.add(labelMesh);

  // Spindle hole
  const hole = new THREE.Mesh(
    new THREE.CylinderGeometry(0.053, 0.053, 0.078, 32),
    new THREE.MeshStandardMaterial({ color: 0x040403, roughness: 0.9 })
  );
  hole.position.y = 0.003;
  vinylGroup.add(hole);
}

// ── Tonearm ───────────────────────────────────────────────────
function buildTonearm() {
  tonearmGroup = new THREE.Group();
  tonearmGroup.position.set(3.2, 0.4, 0);
  turntableGroup.add(tonearmGroup);

  const armMat  = new THREE.MeshStandardMaterial({ color: 0xaeaea8, roughness: 0.15, metalness: 0.85 });
  const darkMat = new THREE.MeshStandardMaterial({ color: 0x242220, roughness: 0.65, metalness: 0.28 });
  const needleMat = new THREE.MeshStandardMaterial({ color: 0xd4d4d0, roughness: 0.07, metalness: 0.96 });

  // Pivot base
  tonearmGroup.add(Object.assign(
    new THREE.Mesh(new THREE.CylinderGeometry(0.15, 0.18, 0.28, 24), darkMat),
    { castShadow: true }
  ));

  // Pivot sphere
  const piv = new THREE.Mesh(new THREE.SphereGeometry(0.13, 22, 22), armMat);
  piv.position.y = 0.16; piv.castShadow = true;
  tonearmGroup.add(piv);

  // Arm tube — extends in -X from pivot
  const armLen = 4.0;
  const arm = new THREE.Mesh(new THREE.CylinderGeometry(0.036, 0.05, armLen, 16), armMat);
  arm.rotation.z = Math.PI / 2;
  arm.position.set(-armLen/2, 0.2, 0);
  arm.castShadow = true;
  tonearmGroup.add(arm);

  // Headshell
  const shell = new THREE.Mesh(new THREE.BoxGeometry(0.27, 0.08, 0.40), armMat);
  shell.position.set(-(armLen+0.08), 0.17, 0.05);
  shell.castShadow = true;
  tonearmGroup.add(shell);

  // Cartridge body (dark block)
  const cart = new THREE.Mesh(new THREE.BoxGeometry(0.17, 0.065, 0.27), darkMat);
  cart.position.set(-(armLen+0.08), 0.1, 0.1);
  tonearmGroup.add(cart);

  // Stylus needle
  const needle = new THREE.Mesh(new THREE.CylinderGeometry(0.009, 0.003, 0.19, 8), needleMat);
  needle.position.set(-(armLen+0.08), 0.035, 0.18);
  needle.rotation.x = 0.28;
  tonearmGroup.add(needle);

  // Counterweight (heavy cylinder at tail)
  const cw = new THREE.Mesh(new THREE.CylinderGeometry(0.11, 0.11, 0.21, 22), darkMat);
  cw.rotation.z = Math.PI/2; cw.position.set(0.5, 0.2, 0);
  cw.castShadow = true;
  tonearmGroup.add(cw);

  // Cueing lever
  const cue = new THREE.Mesh(new THREE.BoxGeometry(0.06, 0.15, 0.06), darkMat);
  cue.position.set(0.17, 0.075, 0.2);
  tonearmGroup.add(cue);
}

// ── Album art texture loader ──────────────────────────────────
// Uses per-face materials so art appears correctly ONLY on the label top face.
// Also applies art to the upright album cover square.
function loadAlbumArtTexture(imageUrl) {
  const loader = new THREE.TextureLoader();
  loader.crossOrigin = 'anonymous';
  loader.load(imageUrl, texture => {
    texture.encoding = THREE.sRGBEncoding;
    albumTexture = texture;

    // CylinderGeometry has 3 material groups: [0]=side, [1]=top cap, [2]=bottom cap
    const topMat = new THREE.MeshStandardMaterial({
      map: texture, color: 0xffffff, roughness: 0.58
    });
    const sideMat = new THREE.MeshStandardMaterial({ color: 0xaaaaaa, roughness: 0.72 });
    labelMesh.material = [sideMat, topMat, sideMat];

    // Apply same art to the upright album cover plane
    if (window.albumCoverMesh) {
      window.albumCoverMesh.material.map = texture;
      window.albumCoverMesh.material.needsUpdate = true;
    }
  }, undefined, err => console.warn('Texture load failed:', err));
}

// ── Animation loop ────────────────────────────────────────────
function animate() {
  requestAnimationFrame(animate);

  // Vinyl spin
  const targetSpeed = isPlaying ? TARGET_SPEED : 0;
  spinSpeed += (targetSpeed - spinSpeed) * 0.030;
  vinylGroup.rotation.y += spinSpeed;

  // Tonearm tracking: slowly sweep inward as song progresses
  if (isPlaying && currentDuration > 0) {
    const progressRatio = currentProgress / currentDuration;
    const inwardSweep = 0.22 * progressRatio;
    tonearmTargetAngle = ARM_ON_RECORD + inwardSweep;
  }

  // Tonearm sweep (Y rotation) — smooth lerp
  tonearmCurrentAngle += (tonearmTargetAngle - tonearmCurrentAngle) * 0.026;
  tonearmGroup.rotation.y = tonearmCurrentAngle;

  // Tonearm lift (Y position) — smooth lerp
  tonearmCurrentH += (tonearmTargetH - tonearmCurrentH) * 0.026;
  tonearmGroup.position.y = tonearmCurrentH;

  renderer.toneMappingExposure = 1.15;
  renderer.render(scene, camera);
}

// ══════════════════════════════════════════════════════════════
// ██████  VINYL COLOR CONTROLS
// ══════════════════════════════════════════════════════════════

function applyVinylColor(hex) {
  if (!vinylMaterial) return;
  vinylMaterial.color.set(new THREE.Color(hex));
  vinylMaterial.needsUpdate = true;
}

function resetVinylToBlack() {
  if (!vinylMaterial) return;
  vinylMaterial.color.set(0x1a1a18);
  vinylMaterial.needsUpdate = true;
}

function setActiveSwatch(id) {
  ['vc-black','vc-album'].forEach(s => {
    document.getElementById(s).classList.toggle('active', s === id);
  });
  document.getElementById('vc-picker-wrap').classList.toggle('active', id === 'picker');
}

// Dominant color extraction via hidden canvas
function extractAndApplyDominantColor(imgUrl) {
  const img = new Image();
  img.crossOrigin = 'anonymous';
  img.onload = () => {
    const c = document.createElement('canvas');
    c.width = c.height = 32;
    const ctx = c.getContext('2d');
    ctx.drawImage(img, 0, 0, 32, 32);
    const d = ctx.getImageData(0, 0, 32, 32).data;
    let r=0, g=0, b=0, n=0;
    for (let i = 0; i < d.length; i += 4) {
      const br = (d[i]+d[i+1]+d[i+2])/3;
      if (br > 18 && br < 238) { r+=d[i]; g+=d[i+1]; b+=d[i+2]; n++; }
    }
    if (n) {
      // Desaturate/darken so it reads as a coloured vinyl (not garish)
      const dr = Math.round(r/n*0.48);
      const dg = Math.round(g/n*0.48);
      const db = Math.round(b/n*0.48);
      dominantColor = '#' + [dr, dg, db].map(v => v.toString(16).padStart(2, '0')).join('');
      applyVinylColor(dominantColor);
    }
  };
  img.src = imgUrl;
}

document.getElementById('vc-black').addEventListener('click', () => {
  activeVinylMode = 'black';
  setActiveSwatch('vc-black');
  resetVinylToBlack();
});

document.getElementById('vc-album').addEventListener('click', () => {
  activeVinylMode = 'album';
  setActiveSwatch('vc-album');
  if (albumTexture?.image?.src) {
    extractAndApplyDominantColor(albumTexture.image.src);
  } else if (dominantColor !== '#181816') {
    applyVinylColor(dominantColor);
  }
});

document.getElementById('vc-picker').addEventListener('input', e => {
  activeVinylMode = 'custom';
  setActiveSwatch('picker');
  applyVinylColor(e.target.value);
});

// ══════════════════════════════════════════════════════════════
// ██████  UI UTILITIES
// ══════════════════════════════════════════════════════════════

function updatePlayButton() {
  document.getElementById('play-icon').style.display  = isPlaying ? 'none'  : 'block';
  document.getElementById('pause-icon').style.display = isPlaying ? 'block' : 'none';
}

function showToast(msg, duration = 3000) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.classList.add('show');
  setTimeout(() => t.classList.remove('show'), duration);
}

document.getElementById('scene-container').addEventListener('click', e => {
  if (e.target.closest('#play-btn'))       return;
  if (e.target.closest('#vinyl-controls')) return;
  togglePlayback();
});
document.getElementById('play-btn').addEventListener('click', togglePlayback);
document.getElementById('login-btn').addEventListener('click', startLogin);

// ══════════════════════════════════════════════════════════════
// ██████  APP INIT
// ══════════════════════════════════════════════════════════════

async function initApp(accessToken) {
  document.getElementById('auth-screen').style.display = 'none';
  document.getElementById('app').classList.add('visible');

  try {
    const me = await spotifyFetch('/me');
    document.getElementById('user-name').textContent = me.display_name || me.id;
  } catch(e) {}

  // Delay Three.js init to let the CSS grid fully paint and measure
  setTimeout(initThree, 80);
  loadLibrary();

  window._tokenReady = true;
  if (window._sdkReady) initPlayer();
}

// ── Bootstrap ─────────────────────────────────────────────────
(async function bootstrap() {
  const params = new URLSearchParams(window.location.search);
  const code   = params.get('code');
  const error  = params.get('error');

  if (error) { showToast('Spotify auth denied: ' + error); return; }

  if (code) {
    try {
      const token = await exchangeCodeForToken(code);
      await initApp(token);
    } catch(e) { console.error(e); showToast('Login failed — try again'); }
    return;
  }

  const existingToken  = sessionStorage.getItem('access_token');
  const existingExpiry = parseInt(sessionStorage.getItem('token_expiry') || '0');
  if (existingToken && Date.now() < existingExpiry) { await initApp(existingToken); return; }

  if (sessionStorage.getItem('refresh_token')) {
    try { const t = await refreshAccessToken(); await initApp(t); return; }
    catch(e) { console.warn('Silent refresh failed'); }
  }
  // Show login screen (default visible state)
})();
</script>
</body>
</html>
